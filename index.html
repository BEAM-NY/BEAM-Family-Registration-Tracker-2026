<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f4f7f9; padding: 20px; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
    .hidden { display: none; }
    .card { border: none; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 550px; margin: auto; background: white; }
    .card-header { background: #004a99; color: white; text-align: center; padding: 25px; border-radius: 12px 12px 0 0; }
    .status-Submitted { color: #198754 !important; font-weight: bold; }
    .status-Not-Submitted { color: #dc3545 !important; font-weight: bold; }
    .progress-complete { background: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
    .progress-inprogress { background: #fff3cd; color: #664d03; border: 1px solid #ffecb5; }
    .progress-notstarted { background: #f8d7da; color: #842029; border: 1px solid #f5c2c7; }
    .timestamp { font-style: italic; color: #777; font-size: 0.8rem; text-align: center; margin: 10px 0; }
    .overall-box { border-radius: 8px; padding: 15px; margin: 15px 0; font-weight: bold; }
    .btn-submit-group { margin-top: 20px; padding: 15px; background: #fffcf5; border: 1px solid #ffeeba; border-radius: 10px; }
    .btn-action { margin-bottom: 12px; border-radius: 8px; font-weight: 600; font-size: 0.9rem; padding: 10px; }
    .table td { padding: 14px 8px; border-bottom: 1px solid #f0f0f0; vertical-align: middle; }
    .doc-name { color: #444; font-size: 0.95rem; }
  </style>
</head>
<body>

  <div id="searchBox" class="card p-0">
    <div class="card-header">
      <h3 class="mb-1">BEAM Student Portal</h3>
      <p class="mb-0 small">Check your registration progress</p>
    </div>
    <div class="card-body p-4">
      <div class="mb-3">
        <label class="form-label fw-bold">Birthdate</label>
        <input type="date" id="dob" class="form-control">
      </div>
      <div class="mb-4">
        <label class="form-label fw-bold">Email</label>
        <input type="email" id="email" class="form-control" placeholder="guardian@email.com">
      </div>
      <button onclick="runSearch()" id="btn" class="btn btn-primary w-100 fw-bold py-2 shadow-sm">Check Status</button>
      <div id="error" class="text-danger mt-3 text-center hidden">No matching student found. Please check your details.</div>
    </div>
  </div>

  <div id="results" class="hidden">
    <div class="card p-0">
      <div class="card-body p-4">
        <div id="content"></div>
        <button onclick="resetSearch()" class="btn btn-link w-100 mt-2 text-decoration-none">‚Üê Search Another Student</button>
      </div>
    </div>
  </div>

  <script>
    // ‚¨áÔ∏è UPDATE THIS URL WITH YOUR NEW DEPLOYMENT URL ‚¨áÔ∏è
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby2ECQfxL6wCulYIeMcDXZlIS0J7mqatkS-9xXutL_z2qONrQ-hb4c74mM1Amg11W9t/exec";

    function resetSearch() {
      document.getElementById('dob').value = '';
      document.getElementById('email').value = '';
      document.getElementById('results').classList.add('hidden');
      document.getElementById('searchBox').classList.remove('hidden');
      document.getElementById('content').innerHTML = '';
    }

    function runSearch() {
      const dob = document.getElementById('dob').value;
      const email = document.getElementById('email').value;
      const btn = document.getElementById('btn');
      
      if(!dob || !email) { alert("Please enter both DOB and Email."); return; }
      
      btn.disabled = true;
      btn.innerText = "Searching...";
      document.getElementById('error').classList.add('hidden');

      // --- JSONP TECHNIQUE ---
      // Instead of 'fetch', we create a script tag.
      // The script tag asks Google for data and Google replies with "handleResponse({...})"
      // This bypasses CORS and Redirect errors completely.
      
      const script = document.createElement('script');
      // We send 'handleResponse' as the callback name
      const safeDob = encodeURIComponent(dob);
      const safeEmail = encodeURIComponent(email);
      script.src = `${SCRIPT_URL}?callback=handleResponse&dob=${safeDob}&email=${safeEmail}`;
      
      // If the script fails to load (e.g. timeout or blocked)
      script.onerror = function() {
        btn.disabled = false;
        btn.innerText = "Check Status";
        alert("Connection timed out. Please try again.");
      };

      // Add the script to the page to trigger the request
      document.body.appendChild(script);
    }

    // This function is CALLED by the Google Script when it loads
    window.handleResponse = function(results) {
      // Remove the script tag to keep DOM clean
      const lastScript = document.body.lastChild;
      if (lastScript.tagName === 'SCRIPT') document.body.removeChild(lastScript);

      render(results);
    };

    function render(results) {
      document.getElementById('btn').disabled = false;
      document.getElementById('btn').innerText = "Check Status";
      if (!results || results.length === 0) {
        document.getElementById('error').classList.remove('hidden');
        return;
      }

      const today = new Date();
      const dateStr = (today.getMonth() + 1) + '/' + today.getDate() + '/' + today.getFullYear();
      let html = '';

      results.forEach(s => {
        const professionalLabels = {
          "Code of Conduct": "Code of Conduct",
          "Attendance": "BEAM Discovery Attendance Policy",
          "Liability Waiver": "Liability Releases",
          "Media Release": "Media Release",
          "Data Consent": "Data Consent Release",
          "Brilliant": "Brilliant.org Consent",
          "Meningitis": "Meningitis Form (Summer Away ONLY)",
          "Report Card": "7th Grade Report Card (Summer Away ONLY)",
          "Parent Med": "Parent Medical Release",
          "Phys Med": "Physician's Medical Release",
          "Immuno": "Immunization Record",
          "Ins Front": "Insurance Card (Front)",
          "Ins Back": "Insurance Card (Back)"
        };

        const surveyForms = ["Liability Waiver", "Media Release", "Code of Conduct", "Data Consent", "Brilliant", "Attendance"];
        const uploadForms = ["Meningitis", "Report Card", "Parent Med", "Phys Med", "Immuno", "Ins Front", "Ins Back"];

        const missingSurvey = s.details.filter(d => d.status !== 'Submitted' && surveyForms.includes(d.name)).length;
        const missingUpload = s.details.filter(d => d.status !== 'Submitted' && uploadForms.includes(d.name)).length;
        const isFullyComplete = (missingSurvey === 0 && missingUpload === 0);

        let progressClass = "progress-inprogress";
        if (s.overall.toLowerCase().includes("complete")) progressClass = "progress-complete";
        if (s.overall.toLowerCase().includes("not started")) progressClass = "progress-notstarted";

        html += `<h4 class="text-primary fw-bold text-center mb-1">${s.alias}</h4>`;
        html += `<div class="text-center"><span class="badge bg-primary mb-2 px-3 rounded-pill">${s.program}</span></div>`;
        
        if (!isFullyComplete) {
          html += `<div class="overall-box text-center ${progressClass}">Registration Status: ${s.overall}</div>`;
        }
        
        html += `<p class="timestamp">Status as of: ${dateStr}, 6:00 AM EST</p>`;
        html += `<table class="table table-sm">`;
        
        s.details.forEach(d => {
          const statusClass = d.status === 'Submitted' ? 'status-Submitted' : 'status-Not-Submitted';
          const displayName = professionalLabels[d.name] || d.name;
          html += `<tr>
                    <td class="doc-name">${displayName}</td>
                    <td class="${statusClass} text-end">${d.status}</td>
                  </tr>`;
        });
        html += `</table>`;

        if (!isFullyComplete) {
          html += `<div class="btn-submit-group shadow-sm">
                    <p class="text-center fw-bold text-dark mb-3">Next Steps to Complete Registration:</p>`;
          if (missingSurvey > 0) {
            html += `<a href="https://www.surveymonkey.com/r/R3PW5S8" target="_blank" class="btn btn-danger btn-action w-100 shadow-sm">Fill missing consent forms here</a>`;
          }
          if (missingUpload > 0) {
            html += `<a href="https://www.surveymonkey.com/r/9GYMKBM" target="_blank" class="btn btn-warning btn-action w-100 shadow-sm text-dark">Upload missing documents here</a>`;
          }
          html += `</div>`;
        } else {
          html += `<div class="alert alert-success mt-4 text-center border-0 shadow-sm">üéâ Everything looks great! Registration is complete.</div>`;
        }
      });

      document.getElementById('content').innerHTML = html;
      document.getElementById('searchBox').classList.add('hidden');
      document.getElementById('results').classList.remove('hidden');
    }
  </script>
</body>
</html>
