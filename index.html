<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>BEAM Student Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f4f7f9; padding: 20px; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
    .hidden { display: none; }
    .card { border: none; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 550px; margin: auto; background: white; }
    .card-header { background: #004a99; color: white; text-align: center; padding: 25px; border-radius: 12px 12px 0 0; }
    .status-Submitted { color: #198754 !important; font-weight: bold; }
    .status-Not-Submitted { color: #dc3545 !important; font-weight: bold; }
    .progress-complete { background: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
    .progress-inprogress { background: #fff3cd; color: #664d03; border: 1px solid #ffecb5; }
    .progress-notstarted { background: #f8d7da; color: #842029; border: 1px solid #f5c2c7; }
    .timestamp { font-style: italic; color: #777; font-size: 0.8rem; text-align: center; margin: 10px 0; }
    .overall-box { border-radius: 8px; padding: 15px; margin: 15px 0; font-weight: bold; }
    .btn-submit-group { margin-top: 20px; padding: 15px; background: #fffcf5; border: 1px solid #ffeeba; border-radius: 10px; }
    .btn-action { margin-bottom: 12px; border-radius: 8px; font-weight: 600; font-size: 0.9rem; padding: 10px; }
    .table td { padding: 14px 8px; border-bottom: 1px solid #f0f0f0; vertical-align: middle; }
    .doc-name { color: #444; font-size: 0.95rem; }
  </style>
</head>
<body>

  <div id="searchBox" class="card p-0">
    <div class="card-header">
      <h3 class="mb-1">BEAM Student Portal</h3>
      <p class="mb-0 small">Check your registration progress</p>
    </div>
    <div class="card-body p-4">
      <div class="mb-3">
        <label class="form-label fw-bold">Birthdate</label>
        <input type="date" id="dob" class="form-control">
      </div>
      <div class="mb-4">
        <label class="form-label fw-bold">Email</label>
        <input type="email" id="email" class="form-control" placeholder="guardian@email.com">
      </div>
      <button onclick="runSearch()" id="btn" class="btn btn-primary w-100 fw-bold py-2 shadow-sm">Check Status</button>
      
      <div id="error" class="alert alert-warning mt-3 text-center hidden" style="font-size: 0.9rem;"></div>
    </div>
  </div>

  <div id="results" class="hidden">
    <div class="card p-0">
      <div class="card-body p-4">
        <div id="content"></div>
        <button onclick="resetSearch()" class="btn btn-link w-100 mt-2 text-decoration-none">← Search Another Student</button>
      </div>
    </div>
  </div>

  <script>
    // ⬇️ YOUR PERSONAL SCRIPT URL ⬇️
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwNBzYcPxE3U-rTGKSqU9IgTYdjJP2glEXsnBMWmx3gQKA08OfaXNK9VaXGkz1U4zzx/exec";

    function resetSearch() {
      document.getElementById('dob').value = '';
      document.getElementById('email').value = '';
      document.getElementById('results').classList.add('hidden');
      document.getElementById('searchBox').classList.remove('hidden');
      document.getElementById('content').innerHTML = '';
    }

    window.receiveData = function(results) {
      const scriptTag = document.getElementById('jsonp_loader');
      if(scriptTag) scriptTag.remove(); 
      render(results);
    };

    function manualFallback() {
      // This function opens the Google Script directly in a new tab.
      // This bypasses ALL cookie bugs because it's a direct visit, not an embed.
      const dob = document.getElementById('dob').value;
      const email = document.getElementById('email').value;
      const safeDob = encodeURIComponent(dob);
      const safeEmail = encodeURIComponent(email);
      window.open(`${SCRIPT_URL}?dob=${safeDob}&email=${safeEmail}`, '_blank');
    }

    function runSearch() {
      const dob = document.getElementById('dob').value;
      const email = document.getElementById('email').value;
      const btn = document.getElementById('btn');
      const errBox = document.getElementById('error');
      
      if(!dob || !email) { alert("Please enter both DOB and Email."); return; }
      
      btn.disabled = true;
      btn.innerText = "Searching...";
      errBox.classList.add('hidden');

      const oldScript = document.getElementById('jsonp_loader');
      if(oldScript) oldScript.remove();

      // Try the seamless method first
      const safeDob = encodeURIComponent(dob);
      const safeEmail = encodeURIComponent(email);
      const script = document.createElement('script');
      script.id = 'jsonp_loader';
      script.src = `${SCRIPT_URL}?callback=receiveData&dob=${safeDob}&email=${safeEmail}`;
      
      // If it fails (Cookie Bug), show the "Safety Valve" button
      script.onerror = function() {
        btn.disabled = false;
        btn.innerText = "Check Status";
        errBox.innerHTML = `
          <strong>Connection Blocked</strong><br>
          Your browser settings (or multiple Google logins) are preventing a direct connection.<br><br>
          <button onclick="manualFallback()" class="btn btn-outline-dark btn-sm fw-bold w-100">Click here to view results securely ↗</button>
        `;
        errBox.classList.remove('hidden');
      };

      document.body.appendChild(script);
    }

    function render(results) {
      document.getElementById('btn').disabled = false;
      document.getElementById('btn').innerText = "Check Status";
      if (!results || results.length === 0) {
        document.getElementById('error').innerHTML = "No matching student found. Please check your details.";
        document.getElementById('error').classList.remove('hidden');
        document.getElementById('error').classList.remove('alert-warning');
        document.getElementById('error').classList.add('text-danger');
        return;
      }

      const today = new Date();
      const dateStr = (today.getMonth() + 1) + '/' + today.getDate() + '/' + today.getFullYear();
      let html = '';

      results.forEach(s => {
        const professionalLabels = { "Code of Conduct": "Code of Conduct", "Attendance": "BEAM Discovery Attendance Policy", "Liability Waiver": "Liability Releases", "Media Release": "Media Release", "Data Consent": "Data Consent Release", "Brilliant": "Brilliant.org Consent", "Meningitis": "Meningitis Form (Summer Away ONLY)", "Report Card": "7th Grade Report Card (Summer Away ONLY)", "Parent Med": "Parent Medical Release", "Phys Med": "Physician's Medical Release", "Immuno": "Immunization Record", "Ins Front": "Insurance Card (Front)", "Ins Back": "Insurance Card (Back)" };
        
        let progressClass = "progress-inprogress";
        if (s.overall.toLowerCase().includes("complete")) progressClass = "progress-complete";
        if (s.overall.toLowerCase().includes("not started")) progressClass = "progress-notstarted";

        html += `<h4 class="text-primary fw-bold text-center mb-1">${s.alias}</h4>`;
        html += `<div class="text-center"><span class="badge bg-primary mb-2 px-3 rounded-pill">${s.program}</span></div>`;
        if (s.overall !== "Complete" && s.overall !== "Confirmed") {
            html += `<div class="overall-box text-center ${progressClass}">Registration Status: ${s.overall}</div>`;
        }
        html += `<p class="timestamp">Status as of: ${dateStr}, 6:00 AM EST</p>`;
        html += `<table class="table table-sm">`;
        s.details.forEach(d => {
            const statusClass = d.status === 'Submitted' ? 'status-Submitted' : 'status-Not-Submitted';
            html += `<tr><td class="doc-name">${professionalLabels[d.name] || d.name}</td><td class="${statusClass} text-end">${d.status}</td></tr>`;
        });
        html += `</table>`;
      });

      document.getElementById('content').innerHTML = html;
      document.getElementById('searchBox').classList.add('hidden');
      document.getElementById('results').classList.remove('hidden');
    }
  </script>
</body>
</html>
